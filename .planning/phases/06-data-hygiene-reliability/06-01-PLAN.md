---
phase: 06-data-hygiene-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/sources/proxy_health.py
  - dolphin/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Proxy health checks retry on transient failures before marking failed"
    - "Permanent failures (403, blocked) are NOT retried"
    - "Retry uses exponential backoff with jitter (not fixed delays)"
  artifacts:
    - path: "dolphin/sources/proxy_health.py"
      provides: "Retry-wrapped proxy check"
      contains: "tenacity"
    - path: "dolphin/requirements.txt"
      provides: "tenacity dependency"
      contains: "tenacity"
  key_links:
    - from: "dolphin/sources/proxy_health.py"
      to: "tenacity"
      via: "retry decorator"
      pattern: "@retry"
---

<objective>
Add exponential backoff with jitter to proxy health checks using tenacity library.

Purpose: Reduce false positives from transient network failures (timeouts, connection errors) by retrying before marking proxy as failed.

Output: Updated proxy_health.py with retry logic, tenacity added to requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-data-hygiene-reliability/06-RESEARCH.md

# Existing proxy health checker
@dolphin/sources/proxy_health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenacity dependency</name>
  <files>dolphin/requirements.txt</files>
  <action>
Add tenacity to requirements.txt.

If requirements.txt doesn't exist, create it with tenacity as the first entry.
If it exists, add tenacity to the list (maintain alphabetical order if the file is alphabetized).

Version: tenacity>=9.0.0
  </action>
  <verify>grep -q "tenacity" dolphin/requirements.txt</verify>
  <done>tenacity appears in requirements.txt</done>
</task>

<task type="auto">
  <name>Task 2: Add retry logic to ProxyHealthChecker</name>
  <files>dolphin/sources/proxy_health.py</files>
  <action>
Modify ProxyHealthChecker to use tenacity for retry with exponential backoff.

1. Add imports at top:
   ```python
   from tenacity import (
       retry,
       stop_after_attempt,
       wait_exponential_jitter,
       retry_if_exception_type,
   )
   ```

2. Create a private retry-wrapped method `_request_with_retry` that:
   - Decorates with @retry
   - Uses stop_after_attempt(3)
   - Uses wait_exponential_jitter(initial=1, max=30, jitter=5)
   - Only retries on transient errors: httpx.ConnectError, httpx.ConnectTimeout
   - Does NOT retry on httpx.ProxyError (credentials/config issue)

3. Update the `check` method to:
   - Use `_request_with_retry` for the actual HTTP request
   - Keep the existing response status handling (200=pass, 403/429=blocked, etc.)
   - Catch tenacity.RetryError when retries exhausted and return fail status

Key point: Do NOT retry on 403/429 responses - these are permanent (IP blocked), not transient.
Only retry on connection-level failures (ConnectError, ConnectTimeout).

Preserve all existing logic for response interpretation.
  </action>
  <verify>python3 -c "from dolphin.sources.proxy_health import ProxyHealthChecker; print('Import OK')"</verify>
  <done>ProxyHealthChecker imports successfully and contains retry decorator</done>
</task>

</tasks>

<verification>
1. `grep -q "@retry" dolphin/sources/proxy_health.py` - retry decorator present
2. `grep -q "wait_exponential_jitter" dolphin/sources/proxy_health.py` - exponential backoff present
3. `grep -q "stop_after_attempt" dolphin/sources/proxy_health.py` - max retries configured
4. `python3 -c "from dolphin.sources.proxy_health import ProxyHealthChecker"` - module imports
</verification>

<success_criteria>
- tenacity added to requirements.txt
- ProxyHealthChecker.check() retries on ConnectError/ConnectTimeout up to 3 times
- Retry uses exponential backoff (1s -> 2s -> 4s) with jitter
- 403/429/blocked responses are NOT retried (permanent failures)
- Existing proxy health check behavior preserved for successful/blocked responses
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-hygiene-reliability/06-01-SUMMARY.md`
</output>
