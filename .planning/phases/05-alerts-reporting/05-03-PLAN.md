---
phase: 05-alerts-reporting
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/reporting.py
  - dolphin/launchd/com.dolphin.weekly-report.plist
autonomous: true

must_haves:
  truths:
    - "Karma velocity calculated as karma/day over 7-day period"
    - "Weekly report shows top 5 and bottom 5 performers"
    - "Report is sent as macOS notification and logged"
    - "Weekly job runs every Sunday at 10 AM"
  artifacts:
    - path: "dolphin/reporting.py"
      provides: "Weekly karma report generation"
      exports: ["calculate_karma_velocity", "generate_weekly_report", "main"]
    - path: "dolphin/launchd/com.dolphin.weekly-report.plist"
      provides: "Weekly scheduled job"
      contains: "StartCalendarInterval"
  key_links:
    - from: "dolphin/reporting.py"
      to: "dolphin/karma_history.json"
      via: "JSON file read"
      pattern: "karma_history\\.json"
    - from: "dolphin/reporting.py"
      to: "dolphin/alerts.py"
      via: "notification sending"
      pattern: "from alerts import"
---

<objective>
Create weekly karma performance reporting

Purpose: Track karma velocity to identify top/bottom performers without manual analysis
Output: reporting.py for karma analysis, weekly launchd job for automated reports
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-alerts-reporting/05-RESEARCH.md

# Existing patterns
@dolphin/tracker.py
@dolphin/config.py
@dolphin/launchd/com.dolphin.tracker.plist
@dolphin/karma_history.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reporting module</name>
  <files>dolphin/reporting.py</files>
  <action>
Create `dolphin/reporting.py` for weekly karma analysis:

1. **Imports**:
```python
#!/usr/bin/env python3
"""Weekly karma performance report generator."""

import json
import logging
import sys
from datetime import datetime, timedelta
from pathlib import Path

from config import setup_logging
from alerts import send_alert
```

2. **Constants**:
```python
HISTORY_FILE = Path(__file__).parent / "karma_history.json"
logger = logging.getLogger("tracker")
```

3. **Functions to implement**:

- `load_karma_history() -> dict`:
  - Load karma_history.json
  - Return empty dict if file missing

- `calculate_karma_velocity(history: dict, days: int = 7) -> dict[str, float]`:
  - For each username in history:
    - Get snapshots within last N days
    - If < 2 snapshots, velocity = 0.0
    - Calculate: (last_karma - first_karma) / days_between
  - Return dict of username -> karma_per_day

- `generate_weekly_report(history: dict) -> str`:
  - Calculate velocities for 7-day period
  - Sort accounts by velocity
  - Format report:
    ```
    Weekly Karma Report (YYYY-MM-DD)

    Top 5 Performers:
    1. username1: +X.X karma/day
    2. username2: +X.X karma/day
    ...

    Needs Attention (lowest growth):
    1. username1: -X.X karma/day
    2. username2: +X.X karma/day
    ...

    Total accounts: N
    ```
  - Return formatted string

- `main() -> int`:
  - setup_logging()
  - Load history
  - If history empty or insufficient data, log warning and return 0
  - Generate report
  - Log full report to file
  - Send condensed notification via send_alert():
    - Title: "Weekly Karma Report"
    - Message: "Top: user1 (+X.X/day), Bottom: userN (-X.X/day)"
  - Return 0 on success, 1 on failure

4. **Entry point**:
```python
if __name__ == "__main__":
    sys.exit(main())
```
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python3 -c "
from reporting import load_karma_history, calculate_karma_velocity, generate_weekly_report

# Load actual history
history = load_karma_history()
print(f'Loaded {len(history)} accounts from karma_history.json')

# Calculate velocities
velocities = calculate_karma_velocity(history, days=7)
print(f'Calculated velocities for {len(velocities)} accounts')

# Generate report
report = generate_weekly_report(history)
print('Report preview:')
print(report[:500])
print('reporting.py OK')
"
```
  </verify>
  <done>reporting.py calculates karma velocity and generates formatted weekly report</done>
</task>

<task type="auto">
  <name>Task 2: Create weekly launchd job</name>
  <files>dolphin/launchd/com.dolphin.weekly-report.plist</files>
  <action>
Create launchd plist for weekly report at `dolphin/launchd/com.dolphin.weekly-report.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.dolphin.weekly-report</string>

    <key>ProgramArguments</key>
    <array>
        <string>/Library/Frameworks/Python.framework/Versions/3.13/bin/python3</string>
        <string>/Users/johnasbury/Reachh/dolphin/reporting.py</string>
    </array>

    <key>WorkingDirectory</key>
    <string>/Users/johnasbury/Reachh/dolphin</string>

    <!-- Run every Sunday at 10 AM -->
    <key>StartCalendarInterval</key>
    <dict>
        <key>Weekday</key>
        <integer>0</integer>
        <key>Hour</key>
        <integer>10</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>

    <key>StandardOutPath</key>
    <string>/Users/johnasbury/Reachh/dolphin/logs/weekly-report.stdout</string>
    <key>StandardErrorPath</key>
    <string>/Users/johnasbury/Reachh/dolphin/logs/weekly-report.stderr</string>
</dict>
</plist>
```

Then install the launchd job:

```bash
# Create symlink to LaunchAgents
ln -sf /Users/johnasbury/Reachh/dolphin/launchd/com.dolphin.weekly-report.plist \
       ~/Library/LaunchAgents/com.dolphin.weekly-report.plist

# Load the job
launchctl load ~/Library/LaunchAgents/com.dolphin.weekly-report.plist
```

Note: Weekday 0 = Sunday in launchd
  </action>
  <verify>
```bash
# Verify plist is valid XML
plutil -lint /Users/johnasbury/Reachh/dolphin/launchd/com.dolphin.weekly-report.plist

# Verify job is loaded
launchctl list | grep weekly-report

# Test manual execution
cd /Users/johnasbury/Reachh/dolphin && python3 reporting.py
echo "Exit code: $?"
```
  </verify>
  <done>Weekly report job installed and scheduled for Sundays at 10 AM</done>
</task>

</tasks>

<verification>
1. `python3 reporting.py` runs and generates report
2. Report shows karma/day rates for accounts
3. macOS notification sent with summary
4. launchd job loaded: `launchctl list | grep weekly-report`
5. Plist validates: `plutil -lint` passes
</verification>

<success_criteria>
- reporting.py exists with calculate_karma_velocity, generate_weekly_report, main
- Karma velocity calculated correctly (karma gained / days elapsed)
- Top 5 and bottom 5 performers identified
- Weekly launchd job runs Sundays at 10 AM
- Report logged to file and sent as notification
</success_criteria>

<output>
After completion, create `.planning/phases/05-alerts-reporting/05-03-SUMMARY.md`
</output>
