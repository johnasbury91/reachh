---
phase: 05-alerts-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/state.py
  - dolphin/alerts.py
autonomous: true
user_setup:
  - service: terminal-notifier
    why: "macOS notification support for pync library"
    env_vars: []
    dashboard_config:
      - task: "Install terminal-notifier via Homebrew"
        location: "Terminal: brew install terminal-notifier"
  - service: slack (optional)
    why: "Team notifications for alerts"
    env_vars:
      - name: SLACK_WEBHOOK_URL
        source: "Slack App Dashboard -> Incoming Webhooks -> Add New Webhook"
    dashboard_config: []

must_haves:
  truths:
    - "State file tracks account statuses and proxy health from previous run"
    - "Changes between runs are detectable (active->suspended, pass->fail)"
    - "macOS notifications appear for alerts"
    - "Slack notifications sent when webhook URL configured"
  artifacts:
    - path: "dolphin/state.py"
      provides: "State loading, saving, and change detection"
      exports: ["load_state", "save_state", "detect_changes"]
    - path: "dolphin/alerts.py"
      provides: "Multi-channel notification dispatcher"
      exports: ["send_alert", "notify_bans", "notify_proxy_failures"]
  key_links:
    - from: "dolphin/state.py"
      to: "dolphin/last_run_state.json"
      via: "JSON file I/O"
      pattern: "json\\.(load|dump)"
    - from: "dolphin/alerts.py"
      to: "pync"
      via: "macOS notification API"
      pattern: "pync\\.notify"
---

<objective>
Create notification infrastructure for alerting on account problems

Purpose: Enable real-time awareness of new bans/suspensions and proxy failures without manual log checking
Output: state.py for change detection, alerts.py for sending notifications
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-alerts-reporting/05-RESEARCH.md

# Existing codebase patterns
@dolphin/config.py
@dolphin/models.py
@dolphin/tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state tracking module</name>
  <files>dolphin/state.py</files>
  <action>
Create `dolphin/state.py` with state tracking and change detection:

1. **State file path**: `dolphin/last_run_state.json`

2. **State structure**:
```python
{
  "accounts": {"username": "status", ...},  # status from RedditStatus
  "proxies": {"proxy_url": "health", ...},  # health from ProxyHealth.status
  "run_at": "ISO timestamp"
}
```

3. **Functions to implement**:
- `load_state() -> dict`: Load previous state from JSON, return empty state if missing
- `save_state(state: dict) -> None`: Atomic write (temp file + rename) to prevent corruption
- `build_current_state(results: list[AccountResult]) -> dict`: Extract state from tracker results
- `detect_changes(previous: dict, current: dict) -> dict`: Return dict with:
  - `new_bans`: list of usernames that went from "active" to "suspended"/"not_found"
  - `new_proxy_failures`: list of proxy URLs that went from "pass" to "fail"/"blocked"

4. **Pattern from research**: Use atomic write pattern (tempfile + os.rename) to prevent JSON corruption

5. **Import from models**: AccountResult, use existing dataclasses
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python3 -c "
from state import load_state, save_state, detect_changes
# Test load (should return empty state)
state = load_state()
print(f'Empty state: {state}')
# Test change detection
prev = {'accounts': {'user1': 'active'}, 'proxies': {'http://1.2.3.4:8080': 'pass'}}
curr = {'accounts': {'user1': 'suspended'}, 'proxies': {'http://1.2.3.4:8080': 'fail'}}
changes = detect_changes(prev, curr)
print(f'Changes: {changes}')
assert changes['new_bans'] == ['user1']
assert changes['new_proxy_failures'] == ['http://1.2.3.4:8080']
print('state.py OK')
"
```
  </verify>
  <done>state.py loads/saves state atomically and detects status changes correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create alerts module</name>
  <files>dolphin/alerts.py</files>
  <action>
Create `dolphin/alerts.py` with multi-channel notification support:

1. **Install dependencies first**:
```bash
pip install pync
```
Note: User must also run `brew install terminal-notifier` for macOS notifications

2. **Settings integration**: Add optional `SLACK_WEBHOOK_URL` to Settings in config.py:
```python
slack_webhook_url: str | None = None
```

3. **Functions to implement**:

- `notify_macos(title: str, message: str) -> None`:
  - Use pync.notify() with group="dolphin-tracker" for grouping
  - Add sound="default" for audible alert
  - Wrap in try/except, log failures but don't raise (best-effort)

- `notify_slack(title: str, message: str) -> None`:
  - Get webhook URL from settings
  - If no URL configured, return silently
  - POST JSON payload: {"text": f"*{title}*\n{message}", "username": "Dolphin Tracker"}
  - Use httpx (already in project), timeout=10
  - Wrap in try/except, log failures but don't raise

- `send_alert(title: str, message: str) -> None`:
  - Call notify_macos()
  - Call notify_slack()
  - Logs what was sent

- `notify_bans(usernames: list[str]) -> None`:
  - If empty list, return
  - Format: title="Account Alert", message="New bans: user1, user2"
  - Call send_alert()

- `notify_proxy_failures(proxies: list[str]) -> None`:
  - If empty list, return
  - Format: title="Proxy Alert", message="Proxies failing: proxy1, proxy2"
  - Call send_alert()

4. **Logging**: Use logger = logging.getLogger("tracker") for consistency with existing code
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python3 -c "
from alerts import notify_bans, notify_proxy_failures, send_alert
# Test with empty lists (should be no-op)
notify_bans([])
notify_proxy_failures([])
# Test macOS notification (will show if terminal-notifier installed)
send_alert('Test Alert', 'This is a test from Dolphin Tracker')
print('alerts.py OK - check for macOS notification')
"
```
  </verify>
  <done>alerts.py sends macOS notifications and optionally Slack; handles failures gracefully</done>
</task>

</tasks>

<verification>
1. Import both modules without errors
2. State detection identifies account status changes correctly
3. macOS notification appears (if terminal-notifier installed)
4. No crashes when Slack webhook not configured
</verification>

<success_criteria>
- state.py exists with load_state, save_state, build_current_state, detect_changes
- alerts.py exists with send_alert, notify_bans, notify_proxy_failures
- State change detection correctly identifies active->suspended transitions
- Notification system works best-effort (failures logged, not raised)
</success_criteria>

<output>
After completion, create `.planning/phases/05-alerts-reporting/05-01-SUMMARY.md`
</output>
