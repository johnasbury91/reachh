---
phase: 05-alerts-reporting
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - dolphin/tracker.py
  - dolphin/config.py
autonomous: true

must_haves:
  truths:
    - "Tracker run compares current state to previous state"
    - "New bans trigger notification during tracker run"
    - "New proxy failures trigger notification during tracker run"
    - "State file updated after each successful run"
  artifacts:
    - path: "dolphin/tracker.py"
      provides: "Integrated alerting in tracker flow"
      contains: "from state import"
    - path: "dolphin/tracker.py"
      provides: "Integrated alerting in tracker flow"
      contains: "from alerts import"
  key_links:
    - from: "dolphin/tracker.py"
      to: "dolphin/state.py"
      via: "import and function calls"
      pattern: "load_state|save_state|detect_changes"
    - from: "dolphin/tracker.py"
      to: "dolphin/alerts.py"
      via: "import and function calls"
      pattern: "notify_bans|notify_proxy_failures"
---

<objective>
Integrate alerts into the tracker workflow

Purpose: Make tracker automatically notify on problems detected during runs
Output: Updated tracker.py that loads previous state, detects changes, and sends alerts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-alerts-reporting/05-RESEARCH.md
@.planning/phases/05-alerts-reporting/05-01-SUMMARY.md

# Files to modify
@dolphin/tracker.py
@dolphin/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Slack webhook to config</name>
  <files>dolphin/config.py</files>
  <action>
Add optional Slack webhook URL to Settings class in config.py:

1. Add field to Settings class (after google_sheets_id):
```python
# Slack notifications (optional)
slack_webhook_url: str | None = None
```

2. No validator needed - empty string or None both mean "not configured"

3. Update .env.example to document the new optional setting:
```
# Optional: Slack webhook for alerts
# SLACK_WEBHOOK_URL=https://hooks.slack.com/services/xxx/yyy/zzz
```
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python3 -c "
from config import settings
print(f'Slack webhook configured: {settings.slack_webhook_url is not None}')
print('config.py OK')
"
```
  </verify>
  <done>Settings class has optional slack_webhook_url field</done>
</task>

<task type="auto">
  <name>Task 2: Integrate alerting into tracker</name>
  <files>dolphin/tracker.py</files>
  <action>
Modify `dolphin/tracker.py` to integrate state tracking and alerts:

1. **Add imports** at top (after existing imports):
```python
from state import load_state, save_state, build_current_state, detect_changes
from alerts import notify_bans, notify_proxy_failures
```

2. **In run_tracker()**, after results are collected but BEFORE Sheets sync:

```python
# Load previous state and detect changes
previous_state = load_state()
current_state = build_current_state(results)
changes = detect_changes(previous_state, current_state)

# Send alerts for new problems
if changes["new_bans"]:
    logger.warning(f"New bans detected: {changes['new_bans']}")
    notify_bans(changes["new_bans"])

if changes["new_proxy_failures"]:
    logger.warning(f"New proxy failures detected: {changes['new_proxy_failures']}")
    notify_proxy_failures(changes["new_proxy_failures"])

# Save current state for next run
save_state(current_state)
```

3. **Placement**: Insert this block after the `for i, profile in enumerate(profiles)` loop completes and results list is populated, but before the CSV export and Sheets sync.

4. **Error handling**: Wrap the alerting block in try/except to ensure tracker continues even if alerting fails:
```python
try:
    # ... alerting code ...
except Exception as e:
    logger.warning(f"Alerting failed: {e}")
    # Continue with CSV export and Sheets sync
```
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python3 -c "
# Verify imports work
from tracker import run_tracker
from state import load_state, build_current_state
from alerts import notify_bans
print('All imports OK')

# Verify tracker module loads without error
import tracker
print('tracker.py loads OK')
"
```
  </verify>
  <done>tracker.py loads state, detects changes, sends alerts, and saves state each run</done>
</task>

</tasks>

<verification>
1. Run `python3 tracker.py --test` - should complete without errors
2. Check `last_run_state.json` exists after run
3. Verify state contains accounts and proxies dicts
4. Second run with no changes should NOT trigger alerts
</verification>

<success_criteria>
- tracker.py imports state and alerts modules
- Each tracker run: loads previous state, builds current state, detects changes
- Alerts sent for new_bans and new_proxy_failures (non-empty lists only)
- State saved after each run for next comparison
- Alerting failures don't crash tracker
</success_criteria>

<output>
After completion, create `.planning/phases/05-alerts-reporting/05-02-SUMMARY.md`
</output>
