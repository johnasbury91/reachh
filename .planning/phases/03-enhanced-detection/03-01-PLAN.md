---
phase: 03-enhanced-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/models.py
  - dolphin/sources/reddit.py
autonomous: true

must_haves:
  truths:
    - "Shadowbanned accounts show status 'shadowbanned' (not 'active')"
    - "Accounts with visible profile but hidden posts are detected"
    - "Accounts with no posts remain 'active' (cannot verify shadowban)"
    - "Suspended/not_found accounts are NOT falsely marked shadowbanned"
  artifacts:
    - path: "dolphin/models.py"
      provides: "RedditStatus with 'shadowbanned' status option"
      contains: "shadowbanned"
    - path: "dolphin/sources/reddit.py"
      provides: "check_shadowban method in RedditChecker"
      exports: ["RedditChecker"]
  key_links:
    - from: "dolphin/sources/reddit.py"
      to: "Reddit submitted.json endpoint"
      via: "httpx GET request"
      pattern: "submitted\\.json"
    - from: "dolphin/sources/reddit.py"
      to: "Reddit permalink"
      via: "httpx GET to verify post visibility"
      pattern: "permalink"
---

<objective>
Add shadowban detection to RedditChecker.

Purpose: Shadowbanned accounts currently show as "active" because about.json returns 200. True shadowban detection requires checking if the user's posts are publicly visible.

Output: RedditChecker with `check_shadowban()` method that detects accounts whose profile exists but posts are hidden from public view.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-enhanced-detection/03-RESEARCH.md
@dolphin/models.py
@dolphin/sources/reddit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shadowbanned status to models</name>
  <files>dolphin/models.py</files>
  <action>
Update RedditStatus dataclass to include "shadowbanned" in the status Literal type:

```python
status: Literal["active", "suspended", "not_found", "rate_limited", "error", "shadowbanned"]
```

This extends the existing status options. No other model changes needed.
  </action>
  <verify>Run `python -c "from dolphin.models import RedditStatus; r = RedditStatus(username='test', status='shadowbanned'); print(r.status)"` - should print "shadowbanned"</verify>
  <done>RedditStatus accepts "shadowbanned" as valid status value</done>
</task>

<task type="auto">
  <name>Task 2: Implement shadowban detection in RedditChecker</name>
  <files>dolphin/sources/reddit.py</files>
  <action>
Add `check_shadowban()` method to RedditChecker class. The detection logic:

1. **Only check accounts already marked "active"** - suspended/not_found accounts are NOT shadowbanned
2. **Fetch user's submitted posts** via `https://www.reddit.com/user/{username}/submitted.json`
3. **If no posts exist** - return "active" (cannot verify shadowban without posts)
4. **Check if most recent post is publicly visible** - fetch the post's permalink directly
5. **If post returns 404** - user is shadowbanned (post exists on profile but not publicly)
6. **If post returns 200** - user is truly active

Implementation:

```python
async def check_shadowban(self, username: str) -> Literal["active", "shadowbanned"]:
    """
    Detect if an active account is actually shadowbanned.

    Only call this for accounts that passed basic check_account() as "active".
    Shadowban = profile exists but posts are not publicly visible.

    Returns:
        "active" - account is truly active (or has no posts to verify)
        "shadowbanned" - profile exists but posts are hidden
    """
```

Key implementation details:
- Use same randomized delay pattern (call `_random_delay()`)
- Handle rate limits with backoff (reuse existing pattern)
- Only check MOST RECENT post to minimize requests (per research recommendation)
- Add try/except for network errors, default to "active" on errors (conservative)

Update `check_account()` to call `check_shadowban()` when status is "active":
- After getting 200 from about.json and setting status="active"
- Call `check_shadowban()` to verify
- If shadowbanned, update status before returning

This keeps the detection automatic - no change to tracker.py needed.
  </action>
  <verify>
1. Run `cd /Users/johnasbury/Reachh/dolphin && python -c "import asyncio; from sources.reddit import RedditChecker; print('imports ok')"`
2. Manual test requires a known shadowbanned account - verify code structure with:
   `grep -n "check_shadowban\|submitted.json\|permalink" dolphin/sources/reddit.py`
  </verify>
  <done>
1. RedditChecker.check_shadowban() method exists and fetches submitted.json
2. check_account() calls check_shadowban() for accounts initially marked "active"
3. Shadowbanned accounts return status="shadowbanned" instead of "active"
  </done>
</task>

</tasks>

<verification>
1. Model import: `python -c "from dolphin.models import RedditStatus; print('ok')"`
2. RedditChecker import: `cd dolphin && python -c "from sources.reddit import RedditChecker; print('ok')"`
3. Shadowban method exists: `grep -c "async def check_shadowban" dolphin/sources/reddit.py` returns 1
4. Submitted.json endpoint used: `grep -c "submitted.json" dolphin/sources/reddit.py` returns >= 1
5. Permalink check exists: `grep -c "permalink" dolphin/sources/reddit.py` returns >= 1
</verification>

<success_criteria>
1. RedditStatus type includes "shadowbanned" as valid status
2. RedditChecker.check_shadowban() method implemented with submitted.json + permalink verification
3. check_account() automatically detects shadowbans for "active" accounts
4. All existing tests/imports continue to work (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-detection/03-01-SUMMARY.md`
</output>
