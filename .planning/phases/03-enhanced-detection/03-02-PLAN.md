---
phase: 03-enhanced-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/models.py
  - dolphin/sources/proxy_health.py
  - dolphin/sheets_sync.py
autonomous: true

must_haves:
  truths:
    - "Each account's proxy health shows pass/fail in Google Sheet"
    - "Proxy health tests Reddit reachability (not just generic connectivity)"
    - "Proxies that work but are blocked by Reddit show 'blocked'"
    - "Proxies with connection failures show 'fail'"
    - "Accounts without proxy show proxy_health as 'N/A'"
  artifacts:
    - path: "dolphin/models.py"
      provides: "ProxyHealth dataclass, AccountResult with proxy_health field"
      contains: "class ProxyHealth"
    - path: "dolphin/sources/proxy_health.py"
      provides: "ProxyHealthChecker class"
      exports: ["ProxyHealthChecker"]
    - path: "dolphin/sheets_sync.py"
      provides: "proxy_health column in HEADERS"
      contains: "proxy_health"
  key_links:
    - from: "dolphin/sources/proxy_health.py"
      to: "Reddit robots.txt"
      via: "httpx GET through proxy"
      pattern: "robots\\.txt"
    - from: "dolphin/sheets_sync.py"
      to: "dolphin/models.py ProxyHealth"
      via: "import and use in _to_row"
      pattern: "proxy_health"
---

<objective>
Add proxy health testing to verify each proxy can reach Reddit.

Purpose: Knowing that a proxy works is not enough - we need to know it can reach Reddit specifically. Some proxies may be blocked by Reddit even if they connect to other sites.

Output: ProxyHealthChecker module that tests proxy connectivity to Reddit, plus proxy_health column in Google Sheet showing pass/fail/blocked status.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-enhanced-detection/03-RESEARCH.md
@dolphin/models.py
@dolphin/sources/dolphin.py
@dolphin/sheets_sync.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ProxyHealth model and update AccountResult</name>
  <files>dolphin/models.py</files>
  <action>
Add ProxyHealth dataclass and update AccountResult:

```python
@dataclass
class ProxyHealth:
    """Result from proxy health check."""
    status: Literal["pass", "fail", "blocked", "N/A"]
    proxy_ip: str | None = None  # IP as seen by target (if available)
    error: str | None = None  # Error message if failed
```

Status meanings:
- "pass" - proxy works AND can reach Reddit
- "fail" - proxy connection failed (timeout, auth error, etc)
- "blocked" - proxy works but Reddit returns 403/429/captcha
- "N/A" - account has no proxy configured

Update AccountResult to include proxy_health:
```python
@dataclass
class AccountResult:
    """Combined result for tracker output."""
    profile: DolphinProfile
    reddit: RedditStatus
    category: str
    karma_change: int = 0
    checked_at: str = ""
    proxy_health: ProxyHealth | None = None  # New field
```
  </action>
  <verify>Run `python -c "from dolphin.models import ProxyHealth, AccountResult; ph = ProxyHealth(status='pass'); print(ph.status)"` - should print "pass"</verify>
  <done>ProxyHealth dataclass exists with status field, AccountResult has proxy_health field</done>
</task>

<task type="auto">
  <name>Task 2: Create ProxyHealthChecker module</name>
  <files>dolphin/sources/proxy_health.py</files>
  <action>
Create new file `dolphin/sources/proxy_health.py` with ProxyHealthChecker class:

```python
"""
Proxy health checker - verifies proxies can reach Reddit.
Tests against Reddit specifically, not generic endpoints.
"""

import httpx
from urllib.parse import quote, urlparse

from dolphin.models import ProxyHealth
from dolphin.config import settings


class ProxyHealthChecker:
    """Test proxy connectivity to Reddit."""

    async def check(self, proxy_url: str, timeout: float = 10.0) -> ProxyHealth:
        """
        Test if proxy can reach Reddit.

        Args:
            proxy_url: Full proxy URL (e.g., "http://user:pass@host:port")
            timeout: Connection timeout in seconds

        Returns:
            ProxyHealth with status and optional error details
        """
```

Implementation details:
1. **Handle "None" proxy string** - return ProxyHealth(status="N/A")
2. **URL-encode credentials** if needed (passwords may contain @, :, etc)
3. **Test Reddit reachability** via `https://www.reddit.com/robots.txt` (lightweight, always exists)
4. **Interpret response codes:**
   - 200 = pass
   - 403 = blocked (Reddit blocking this IP)
   - 429 = blocked (rate limited, likely flagged IP)
   - Connection error = fail
   - Timeout = fail

Use httpx.AsyncClient with proxy parameter. Do NOT reuse existing client - create fresh client per check to test the specific proxy.

Add helper to encode proxy URL credentials:
```python
def _encode_proxy_url(self, proxy_url: str) -> str:
    """URL-encode credentials in proxy URL to handle special characters."""
    # Parse URL, encode user:pass, reconstruct
```
  </action>
  <verify>
1. File exists: `ls dolphin/sources/proxy_health.py`
2. Import works: `cd dolphin && python -c "from sources.proxy_health import ProxyHealthChecker; print('ok')"`
3. Check method exists: `grep -c "async def check" dolphin/sources/proxy_health.py` returns 1
  </verify>
  <done>ProxyHealthChecker class with check() method that tests Reddit reachability through given proxy</done>
</task>

<task type="auto">
  <name>Task 3: Add proxy_health column to Google Sheet</name>
  <files>dolphin/sheets_sync.py</files>
  <action>
Update sheets_sync.py to include proxy_health column:

1. **Update HEADERS** - add "proxy_health" after "proxy" column:
```python
HEADERS = [
    "profile_id",
    "username",
    "status",
    "total_karma",
    "comment_karma",
    "link_karma",
    "account_age",
    "owner",
    "proxy",
    "proxy_health",  # NEW - position after proxy
    "karma_delta",
    "checked_at",
]
```

2. **Update _to_row()** - extract proxy_health status from AccountResult:
```python
# Get proxy health status
proxy_health_status = "N/A"
if result.proxy_health:
    proxy_health_status = result.proxy_health.status

return [
    ...
    result.profile.proxy or "None",
    proxy_health_status,  # NEW
    karma_delta,
    result.checked_at or datetime.now().isoformat(),
]
```

3. **Update range in _ensure_headers** - change from K to L (now 12 columns A-L):
```python
worksheet.update("A1:L1", [HEADERS])
```

4. **Update range in sync_to_sheet updates** - change from K to L:
```python
updates.append({
    "range": f"A{row_num}:L{row_num}",
    "values": [row_data],
})
```
  </action>
  <verify>
1. HEADERS count: `python -c "from dolphin.sheets_sync import HEADERS; print(len(HEADERS))"` should print 12
2. proxy_health in HEADERS: `python -c "from dolphin.sheets_sync import HEADERS; print('proxy_health' in HEADERS)"` should print True
3. Import still works: `python -c "from dolphin.sheets_sync import sync_to_sheet; print('ok')"`
  </verify>
  <done>Google Sheet now has 12 columns (A-L) with proxy_health column after proxy</done>
</task>

</tasks>

<verification>
1. ProxyHealth model: `python -c "from dolphin.models import ProxyHealth; print(ProxyHealth(status='pass'))"`
2. AccountResult has proxy_health: `python -c "from dolphin.models import AccountResult, DolphinProfile, RedditStatus, ProxyHealth; ar = AccountResult(profile=DolphinProfile(id='1',name='t',owner='o',notes='',created_at='',updated_at=''), reddit=RedditStatus(username='t',status='active'), category='test', proxy_health=ProxyHealth(status='pass')); print(ar.proxy_health.status)"`
3. ProxyHealthChecker import: `cd dolphin && python -c "from sources.proxy_health import ProxyHealthChecker; print('ok')"`
4. HEADERS has 12 columns: `python -c "from dolphin.sheets_sync import HEADERS; assert len(HEADERS) == 12; print('ok')"`
</verification>

<success_criteria>
1. ProxyHealth dataclass with status Literal["pass", "fail", "blocked", "N/A"]
2. AccountResult includes optional proxy_health field
3. ProxyHealthChecker.check() tests Reddit reachability via robots.txt
4. Google Sheet HEADERS includes "proxy_health" column (12 columns total)
5. _to_row() extracts proxy_health status for sheet output
</success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-detection/03-02-SUMMARY.md`
</output>
