---
phase: 02-google-sheets-sync
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - dolphin/sources/dolphin.py
  - dolphin/models.py
  - dolphin/sheets_sync.py
autonomous: true

must_haves:
  truths:
    - "Each account row in Sheet shows proxy info (e.g., http://1.2.3.4:8080)"
    - "Accounts without proxy show 'None' in proxy column"
    - "Proxy data comes from Dolphin API response (not hardcoded)"
  artifacts:
    - path: "dolphin/sources/dolphin.py"
      provides: "Proxy extraction from profile"
      contains: "proxy"
    - path: "dolphin/models.py"
      provides: "Extended DolphinProfile with proxy"
      contains: "proxy"
    - path: "dolphin/sheets_sync.py"
      provides: "Proxy column in sheet output"
      contains: "proxy"
  key_links:
    - from: "dolphin/sources/dolphin.py"
      to: "Dolphin API response"
      via: "proxy field extraction"
      pattern: "p\\.get\\(['\"]proxy['\"]"
    - from: "dolphin/models.py"
      to: "dolphin/sources/dolphin.py"
      via: "DolphinProfile dataclass"
      pattern: "proxy.*str"
    - from: "dolphin/sheets_sync.py"
      to: "dolphin/models.py"
      via: "proxy in row data"
      pattern: "profile\\.proxy|result\\.profile\\.proxy"
---

<objective>
Extract proxy information from Dolphin API and display in Google Sheet.

Purpose: Show which proxy each account uses so you can correlate bans/issues with specific proxies.
Output: Proxy column in Google Sheet showing formatted proxy URL for each account.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-google-sheets-sync/02-RESEARCH.md

# Prior plan SUMMARY (sheets module created)
@.planning/phases/02-google-sheets-sync/02-01-SUMMARY.md

# Code to modify
@dolphin/sources/dolphin.py
@dolphin/models.py
@dolphin/sheets_sync.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract proxy from Dolphin API response</name>
  <files>dolphin/sources/dolphin.py, dolphin/models.py</files>
  <action>
1. **Extend DolphinProfile dataclass in models.py:**
   Add `proxy: str = ""` field after existing fields.

2. **Modify get_profiles() in sources/dolphin.py:**

   After line 99 (before profiles.append), extract proxy:
   ```python
   # Extract proxy info from profile
   proxy_data = p.get("proxy", {})
   proxy_str = format_proxy(proxy_data) if proxy_data else "None"
   ```

3. **Add format_proxy helper function in sources/dolphin.py:**
   ```python
   def format_proxy(proxy_data: dict | None) -> str:
       """Format proxy for display. Returns 'None' if no proxy."""
       if not proxy_data:
           return "None"

       host = proxy_data.get("host", "")
       port = proxy_data.get("port", "")
       proxy_type = proxy_data.get("type", "http")

       if not host:
           return "None"

       return f"{proxy_type}://{host}:{port}"
   ```

4. **Add proxy to DolphinProfile creation:**
   ```python
   profiles.append(
       DolphinProfile(
           id=str(p["id"]),
           name=p["name"],
           owner=owner,
           notes=notes_content,
           created_at=p.get("created_at", ""),
           updated_at=p.get("updated_at", ""),
           proxy=proxy_str,  # NEW
       )
   )
   ```

Note: From RESEARCH.md, the Dolphin API returns proxy as an object with host, port, type, login, password fields. We only need host:port for display.
  </action>
  <verify>
cd /Users/johnasbury/Reachh/dolphin && python3 -c "from models import DolphinProfile; p = DolphinProfile(id='1', name='test', owner='x', notes='', created_at='', updated_at='', proxy='http://1.2.3.4:8080'); print(f'proxy={p.proxy}')" 2>&1 | grep -q "proxy=http"
  </verify>
  <done>
- DolphinProfile has proxy field
- format_proxy function extracts type://host:port
- get_profiles populates proxy from API response
  </done>
</task>

<task type="auto">
  <name>Task 2: Add proxy column to Google Sheet</name>
  <files>dolphin/sheets_sync.py</files>
  <action>
1. **Update header row constant:**
   Change column order to include proxy:
   `profile_id, username, status, total_karma, comment_karma, link_karma, owner, proxy, karma_delta, checked_at`
   (10 columns now, proxy before karma_delta)

2. **Update to_row helper function:**
   Add `result.profile.proxy` to the row data list in correct position.

3. **Update range references:**
   Change `A{row}:I{row}` to `A{row}:J{row}` (10 columns now).

4. **Ensure backward compatibility:**
   If existing sheet has 9 columns (no proxy), the code should still work.
   The batch_update with explicit ranges handles this - new rows get 10 columns.
  </action>
  <verify>
cd /Users/johnasbury/Reachh/dolphin && grep -q "proxy" sheets_sync.py && grep -q "J{row" sheets_sync.py
  </verify>
  <done>
- Header includes proxy column
- to_row includes profile.proxy
- Range updated to J (10 columns)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify proxy extraction with test run</name>
  <files>None (verification only)</files>
  <action>
Run verification commands to ensure proxy extraction works:

1. **Test DolphinClient proxy extraction:**
   ```bash
   cd /Users/johnasbury/Reachh/dolphin && python3 -c "
   import asyncio
   from sources.dolphin import DolphinClient

   async def test():
       async with DolphinClient() as client:
           profiles = await client.get_profiles()
           for p in profiles[:3]:
               print(f'{p.name}: proxy={p.proxy}')

   asyncio.run(test())
   "
   ```

2. **Verify at least some profiles have proxy data.**
   If all show "None", the API might not return proxy in list endpoint.
   In that case, note this in summary - may need to fetch individual profiles.

3. **Run full tracker test:**
   ```bash
   cd /Users/johnasbury/Reachh/dolphin && python3 tracker.py --test
   ```

4. **Check Google Sheet:**
   Verify proxy column appears with data or "None" values.
  </action>
  <verify>
cd /Users/johnasbury/Reachh/dolphin && python3 tracker.py --test 2>&1 | grep -q "Sheets sync complete"
  </verify>
  <done>
- Proxy field populated from Dolphin API
- Proxy appears in Google Sheet
- Accounts without proxy show "None"
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -q "proxy" dolphin/models.py` - field added
2. `grep -q "format_proxy" dolphin/sources/dolphin.py` - extraction function exists
3. `grep -q "proxy" dolphin/sheets_sync.py` - column in sheet
4. Run tracker --test and verify proxy column in Sheet
</verification>

<success_criteria>
- DolphinProfile dataclass has proxy field
- Google Sheet has proxy column (after owner, before karma_delta)
- Accounts with proxy show "http://host:port" or "socks5://host:port"
- Accounts without proxy show "None"
</success_criteria>

<output>
After completion, create `.planning/phases/02-google-sheets-sync/02-02-SUMMARY.md`
</output>
