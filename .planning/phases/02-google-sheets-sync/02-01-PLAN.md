---
phase: 02-google-sheets-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/config.py
  - dolphin/sheets_sync.py
  - dolphin/tracker.py
  - dolphin/requirements.txt
autonomous: false

user_setup:
  - service: google-sheets
    why: "Store account data in spreadsheet"
    env_vars:
      - name: GOOGLE_CREDENTIALS_JSON
        source: "Google Cloud Console -> Service Account -> Keys -> Create JSON key -> Copy entire JSON content"
      - name: GOOGLE_SHEETS_ID
        source: "Google Sheets URL: https://docs.google.com/spreadsheets/d/{THIS_ID}/edit"
    dashboard_config:
      - task: "Create Google Cloud service account"
        location: "console.cloud.google.com -> IAM & Admin -> Service Accounts -> Create"
      - task: "Enable Google Sheets API"
        location: "console.cloud.google.com -> APIs & Services -> Enable APIs -> Google Sheets API"
      - task: "Share spreadsheet with service account email"
        location: "Google Sheet -> Share -> Add service account email as Editor"

must_haves:
  truths:
    - "Running tracker.py updates a Google Sheet with account data"
    - "Sheet contains columns: profile_id, username, status, total_karma, comment_karma, link_karma, owner, karma_delta, checked_at"
    - "Multiple runs update existing rows (upsert by profile_id, not duplicates)"
    - "500+ accounts sync without 429 errors (batch operations)"
  artifacts:
    - path: "dolphin/sheets_sync.py"
      provides: "Google Sheets sync module"
      min_lines: 80
      exports: ["sync_to_sheet"]
    - path: "dolphin/config.py"
      provides: "Extended with Sheets credentials"
      contains: "google_credentials_json"
    - path: "dolphin/tracker.py"
      provides: "Calls sheets_sync after data collection"
      contains: "sync_to_sheet"
  key_links:
    - from: "dolphin/tracker.py"
      to: "dolphin/sheets_sync.py"
      via: "import and function call"
      pattern: "from sheets_sync import|sync_to_sheet\\("
    - from: "dolphin/sheets_sync.py"
      to: "gspread"
      via: "service_account_from_dict"
      pattern: "gspread\\.service_account_from_dict"
    - from: "dolphin/sheets_sync.py"
      to: "worksheet"
      via: "batch_update for upsert"
      pattern: "batch_update\\("
---

<objective>
Create Google Sheets sync module with service account authentication and batch upsert operations.

Purpose: Enable automatic sync of account data to Google Sheets without manual copy-paste, with batched operations to avoid API quota errors.
Output: Working sheets_sync.py module that tracker.py calls to update a Google Sheet.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-google-sheets-sync/02-RESEARCH.md

# Phase 1 code to extend
@dolphin/config.py
@dolphin/tracker.py
@dolphin/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gspread dependency and extend config</name>
  <files>dolphin/requirements.txt, dolphin/config.py</files>
  <action>
1. Add gspread and google-auth to requirements.txt:
   ```
   gspread>=6.0.0
   google-auth>=2.0.0
   ```

2. Extend dolphin/config.py Settings class with Google Sheets configuration:
   - Add `google_credentials_json: SecretStr` (JSON string from env var)
   - Add `google_sheets_id: str` (spreadsheet ID from URL)
   - Add validator to ensure credentials JSON is valid (can be parsed)
   - Keep all existing settings unchanged

3. Add to .env.example:
   ```
   GOOGLE_CREDENTIALS_JSON={"type":"service_account",...}
   GOOGLE_SHEETS_ID=your-spreadsheet-id-here
   ```

Do NOT install packages yet - that happens in verification.
  </action>
  <verify>
grep -q "gspread" dolphin/requirements.txt && grep -q "google_credentials_json" dolphin/config.py
  </verify>
  <done>
- requirements.txt has gspread and google-auth
- config.py has google_credentials_json and google_sheets_id fields
- .env.example has placeholder values
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sheets_sync module with batch upsert</name>
  <files>dolphin/sheets_sync.py</files>
  <action>
Create dolphin/sheets_sync.py with:

1. **Imports:**
   - gspread, json
   - from config import settings
   - from models import AccountResult

2. **sync_to_sheet(results: list[AccountResult]) -> dict function:**
   - Load credentials: `json.loads(settings.google_credentials_json.get_secret_value())`
   - Connect: `gspread.service_account_from_dict(credentials)`
   - Open sheet: `gc.open_by_key(settings.google_sheets_id).sheet1`

3. **Sheet structure (header row 1):**
   Column order: profile_id, username, status, total_karma, comment_karma, link_karma, owner, karma_delta, checked_at

4. **Upsert logic (CRITICAL for INFRA-04 - batch operations):**
   ```python
   # Read existing data (single API call)
   existing = worksheet.get_all_records(default_blank='')
   existing_ids = {str(row['profile_id']): idx + 2 for idx, row in enumerate(existing)}

   # Partition into updates vs inserts
   updates = []
   inserts = []
   for result in results:
       row_data = to_row(result)  # helper function
       if result.profile.id in existing_ids:
           row_num = existing_ids[result.profile.id]
           updates.append({'range': f'A{row_num}:I{row_num}', 'values': [row_data]})
       else:
           inserts.append(row_data)

   # Batch update (single API call)
   if updates:
       worksheet.batch_update(updates)

   # Batch append (single API call)
   if inserts:
       worksheet.append_rows(inserts)
   ```

5. **to_row helper function:**
   Convert AccountResult to list matching column order.
   Format karma_delta as "+N" or "-N" string for readability.
   Handle None/missing values gracefully.

6. **Ensure header row exists:**
   Check if row 1 is empty, if so write header row first.

7. **Return stats dict:** `{"updated": len(updates), "inserted": len(inserts)}`

Key patterns from RESEARCH.md:
- Use batch_update() not individual update_acell()
- Use get_all_records() for dict access
- Use append_rows() for multiple inserts
- Maximum ~5 API calls per sync (header check, read all, update batch, insert batch)
  </action>
  <verify>
python3 -c "from sheets_sync import sync_to_sheet; print('Import OK')" 2>&1 | grep -q "Import OK" || python3 -c "import sys; sys.path.insert(0, 'dolphin'); from sheets_sync import sync_to_sheet; print('Import OK')"
  </verify>
  <done>
- sheets_sync.py exists with sync_to_sheet function
- Uses batch_update() and append_rows() (not cell-by-cell)
- Upsert logic keys on profile_id
- Returns update/insert counts
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate sheets sync into tracker.py</name>
  <files>dolphin/tracker.py</files>
  <action>
Modify dolphin/tracker.py run_tracker() function:

1. **Add import at top:**
   ```python
   from sheets_sync import sync_to_sheet
   ```

2. **After CSV export (around line 169), add sheets sync:**
   ```python
   # Sync to Google Sheets
   try:
       print("\nSyncing to Google Sheets...")
       stats = sync_to_sheet(results)
       print(f"Sheets sync complete: {stats['updated']} updated, {stats['inserted']} inserted")
   except Exception as e:
       print(f"Warning: Sheets sync failed: {e}")
       # Don't fail the whole run - CSV export already succeeded
   ```

3. **Keep all existing functionality unchanged:**
   - CSV export still works
   - Summary printing still works
   - History saving still works

The sheets sync is additive - if it fails, the tracker still completes successfully with CSV output.
  </action>
  <verify>
grep -q "sync_to_sheet" dolphin/tracker.py && grep -q "Syncing to Google Sheets" dolphin/tracker.py
  </verify>
  <done>
- tracker.py imports sync_to_sheet
- tracker.py calls sync_to_sheet(results) after CSV export
- Failure is caught and logged (doesn't crash tracker)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Google Sheets sync module with batch upsert, integrated into tracker.py
  </what-built>
  <how-to-verify>
1. **Setup (one-time):**
   - Create/configure Google Cloud service account (see user_setup above)
   - Add credentials to dolphin/.env:
     ```
     GOOGLE_CREDENTIALS_JSON={"type":"service_account",...entire JSON...}
     GOOGLE_SHEETS_ID=your-sheet-id
     ```
   - Share your Google Sheet with the service account email (as Editor)

2. **Install dependencies:**
   ```bash
   cd dolphin && pip install -r requirements.txt
   ```

3. **Run tracker in test mode:**
   ```bash
   cd dolphin && python3 tracker.py --test
   ```

4. **Verify in Google Sheet:**
   - Open your sheet
   - Should see header row: profile_id, username, status, total_karma, comment_karma, link_karma, owner, karma_delta, checked_at
   - Should see 5 data rows (from --test mode)
   - Run again - should update existing rows, not create duplicates

5. **Verify batch operations (check terminal output):**
   - Should NOT see multiple "updating cell" messages
   - Should see single "Sheets sync complete: X updated, Y inserted"
  </how-to-verify>
  <resume-signal>Type "approved" if data appears in Google Sheet correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -q "gspread" dolphin/requirements.txt` - dependency added
2. `grep -q "sync_to_sheet" dolphin/tracker.py` - integration complete
3. `grep -q "batch_update" dolphin/sheets_sync.py` - batch operations used
4. Manual: Run tracker --test and verify Sheet updates without duplicates
</verification>

<success_criteria>
- Running `python3 tracker.py --test` updates a Google Sheet
- Existing rows update (upsert), no duplicates created
- All 9 columns present: profile_id, username, status, total_karma, comment_karma, link_karma, owner, karma_delta, checked_at
- No 429 errors during sync (batch operations working)
</success_criteria>

<output>
After completion, create `.planning/phases/02-google-sheets-sync/02-01-SUMMARY.md`
</output>
