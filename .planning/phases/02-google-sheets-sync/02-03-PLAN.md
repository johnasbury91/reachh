---
phase: 02-google-sheets-sync
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - dolphin/models.py
  - dolphin/sheets_sync.py
autonomous: true

must_haves:
  truths:
    - "Each account row in Sheet shows account age (e.g., '2y 3m' or '45d')"
    - "Suspended or not-found accounts show 'N/A' for account age"
    - "Karma delta column shows change since last check (e.g., '+15' or '-3')"
    - "First-time checked accounts show '0' for karma delta"
  artifacts:
    - path: "dolphin/sheets_sync.py"
      provides: "Account age and karma delta columns"
      contains: ["account_age", "karma_delta"]
    - path: "dolphin/models.py"
      provides: "Account age calculation helper"
      contains: "calculate_account_age"
  key_links:
    - from: "dolphin/sheets_sync.py"
      to: "reddit.created_utc"
      via: "calculate_account_age function"
      pattern: "calculate_account_age\\(.*created_utc"
    - from: "dolphin/sheets_sync.py"
      to: "result.karma_change"
      via: "delta formatting"
      pattern: "karma_change|karma_delta"
---

<objective>
Add account age calculation and ensure karma delta displays correctly in Google Sheet.

Purpose: Show how old each Reddit account is and track karma growth/decline over time.
Output: Account age column (e.g., "2y 3m") and properly formatted karma delta column (e.g., "+15").
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-google-sheets-sync/02-RESEARCH.md

# Prior plan SUMMARYs (sheets module + proxy column)
@.planning/phases/02-google-sheets-sync/02-01-SUMMARY.md
@.planning/phases/02-google-sheets-sync/02-02-SUMMARY.md

# Code to modify
@dolphin/models.py
@dolphin/sheets_sync.py

# Reference for created_utc field
@dolphin/sources/reddit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add account age calculation function</name>
  <files>dolphin/models.py</files>
  <action>
Add calculate_account_age function to models.py:

```python
from datetime import datetime, timezone

def calculate_account_age(created_utc: float) -> str:
    """Convert Reddit created_utc timestamp to human-readable age.

    Args:
        created_utc: Unix timestamp from Reddit API (UTC)

    Returns:
        Human-readable age like "2y 3m", "6m", or "15d"
        Returns "N/A" for invalid/zero timestamps
    """
    if created_utc <= 0:
        return "N/A"

    created = datetime.fromtimestamp(created_utc, tz=timezone.utc)
    now = datetime.now(tz=timezone.utc)
    delta = now - created

    days = delta.days
    if days < 0:
        return "N/A"  # Future date (shouldn't happen)

    years = days // 365
    months = (days % 365) // 30

    if years > 0:
        return f"{years}y {months}m"
    elif months > 0:
        return f"{months}m"
    else:
        return f"{days}d"
```

This matches the pattern from RESEARCH.md.
  </action>
  <verify>
cd /Users/johnasbury/Reachh/dolphin && python3 -c "from models import calculate_account_age; import time; age = calculate_account_age(time.time() - 400*86400); print(f'age={age}')" 2>&1 | grep -q "y\|m"
  </verify>
  <done>
- calculate_account_age function exists in models.py
- Returns "Xy Ym" for years+months, "Xm" for months only, "Xd" for days
- Handles 0/negative timestamps as "N/A"
  </done>
</task>

<task type="auto">
  <name>Task 2: Add account_age column to sheet and format karma_delta</name>
  <files>dolphin/sheets_sync.py</files>
  <action>
**Important:** This task builds on 02-02 which added proxy column (10 columns total). We now add account_age for 11 columns.

1. **Import the new function:**
   ```python
   from models import AccountResult, calculate_account_age
   ```

2. **Update header row to include account_age:**
   Final column order (11 columns):
   `profile_id, username, status, total_karma, comment_karma, link_karma, account_age, owner, proxy, karma_delta, checked_at`

   Note: account_age goes after karma columns, before owner (logical grouping).

3. **Update to_row helper function:**
   ```python
   def to_row(result: AccountResult) -> list:
       """Convert AccountResult to sheet row."""
       # Calculate account age from Reddit created_utc
       account_age = calculate_account_age(result.reddit.created_utc)

       # Format karma delta with +/- sign
       delta = result.karma_change
       if delta > 0:
           karma_delta_str = f"+{delta}"
       elif delta < 0:
           karma_delta_str = str(delta)  # Already has minus
       else:
           karma_delta_str = "0"

       return [
           result.profile.id,
           result.profile.name,
           result.reddit.status,
           result.reddit.total_karma,
           result.reddit.comment_karma,
           result.reddit.link_karma,
           account_age,
           result.profile.owner,
           result.profile.proxy,
           karma_delta_str,
           result.checked_at,
       ]
   ```

4. **Update range references:**
   Change `A{row}:J{row}` to `A{row}:K{row}` (11 columns now).

5. **Update header row list:**
   ```python
   HEADER_ROW = [
       "profile_id", "username", "status", "total_karma", "comment_karma",
       "link_karma", "account_age", "owner", "proxy", "karma_delta", "checked_at"
   ]
   ```
  </action>
  <verify>
cd /Users/johnasbury/Reachh/dolphin && grep -q "account_age" sheets_sync.py && grep -q "K{row" sheets_sync.py
  </verify>
  <done>
- Header includes account_age column
- to_row calculates age from created_utc
- Karma delta formatted with +/- prefix
- Range updated to K (11 columns)
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification</name>
  <files>None (verification only)</files>
  <action>
Run full verification:

1. **Test account age calculation with edge cases:**
   ```bash
   cd /Users/johnasbury/Reachh/dolphin && python3 -c "
   from models import calculate_account_age
   import time

   # Test cases
   now = time.time()
   print(f'2 years ago: {calculate_account_age(now - 730*86400)}')  # ~2y
   print(f'6 months ago: {calculate_account_age(now - 180*86400)}')  # ~6m
   print(f'15 days ago: {calculate_account_age(now - 15*86400)}')    # 15d
   print(f'Zero timestamp: {calculate_account_age(0)}')              # N/A
   print(f'Negative: {calculate_account_age(-100)}')                 # N/A
   "
   ```

2. **Run tracker test and verify sheet:**
   ```bash
   cd /Users/johnasbury/Reachh/dolphin && python3 tracker.py --test
   ```

3. **Check Google Sheet columns:**
   - account_age column shows values like "2y 3m", "6m", "15d"
   - karma_delta shows "+N", "-N", or "0"
   - Suspended/not_found accounts show "N/A" for age (created_utc = 0)

4. **Verify karma delta changes on second run:**
   - Run tracker --test again
   - karma_delta should update if karma changed
   - First-run accounts should show "0" delta
  </action>
  <verify>
cd /Users/johnasbury/Reachh/dolphin && python3 tracker.py --test 2>&1 | grep -q "Sheets sync complete"
  </verify>
  <done>
- Account age displays correctly for all status types
- Karma delta shows +/- prefix correctly
- Second run updates delta based on karma change
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -q "calculate_account_age" dolphin/models.py` - function exists
2. `grep -q "account_age" dolphin/sheets_sync.py` - column in sheet
3. Run tracker --test twice and verify:
   - Account age column has values
   - Karma delta updates between runs
</verification>

<success_criteria>
- Account age shows human-readable duration (e.g., "2y 3m")
- Active accounts have real age from Reddit created_utc
- Suspended/not_found accounts show "N/A" for age
- Karma delta formatted with +/- sign
- Repeat runs show delta change correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-google-sheets-sync/02-03-SUMMARY.md`
</output>
