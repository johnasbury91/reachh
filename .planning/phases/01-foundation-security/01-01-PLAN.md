---
phase: 01-foundation-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/.env
  - dolphin/.env.example
  - dolphin/config.py
  - dolphin/.gitignore
autonomous: true

must_haves:
  truths:
    - "Running tracker.py loads DOLPHIN_API_KEY from .env file, not from hardcoded value"
    - "config.py contains no secrets (JWT tokens, API keys)"
    - ".env file is ignored by git (never committed)"
  artifacts:
    - path: "dolphin/.env"
      provides: "Actual credentials for runtime"
      contains: "DOLPHIN_API_KEY="
    - path: "dolphin/.env.example"
      provides: "Template for other developers"
      contains: "DOLPHIN_API_KEY=your_jwt_token_here"
    - path: "dolphin/config.py"
      provides: "Settings class using pydantic-settings"
      contains: "class Settings"
      exports: ["settings"]
    - path: "dolphin/.gitignore"
      provides: "Git ignore rules for secrets"
      contains: ".env"
  key_links:
    - from: "dolphin/config.py"
      to: "dolphin/.env"
      via: "pydantic-settings env_file"
      pattern: "env_file.*\\.env"
---

<objective>
Remove exposed JWT token from source code and implement secure credential loading via pydantic-settings.

Purpose: URGENT security fix - config.py currently has a hardcoded JWT token visible in plaintext. This must be the first task in Phase 1.

Output:
- `.env` file with actual credentials (git-ignored)
- `.env.example` template (committed, no real secrets)
- Secure `config.py` using pydantic-settings for type-safe configuration
- Updated `.gitignore` to prevent future credential exposure
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-security/01-RESEARCH.md

# Existing code to refactor
@dolphin/config.py
@dolphin/tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create .gitignore</name>
  <files>dolphin/.gitignore, dolphin/requirements.txt</files>
  <action>
1. Create or update `dolphin/.gitignore` with:
   - `.env` (actual credentials)
   - `*.pyc`, `__pycache__/`
   - `karma_history.json` (runtime data)
   - `tracking_*.csv` (output files)

2. Create or update `dolphin/requirements.txt` with Phase 1 dependencies:
   - httpx>=0.28
   - pydantic>=2.0
   - pydantic-settings>=2.0

3. Install dependencies: `pip install -r dolphin/requirements.txt`

IMPORTANT: Create .gitignore BEFORE creating .env to ensure .env is never staged.
  </action>
  <verify>
- `cat dolphin/.gitignore` shows `.env` listed
- `pip list | grep -i pydantic` shows pydantic and pydantic-settings installed
- `pip list | grep -i httpx` shows httpx installed
  </verify>
  <done>.gitignore blocks .env, all dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create .env files and secure config.py</name>
  <files>dolphin/.env, dolphin/.env.example, dolphin/config.py</files>
  <action>
1. Extract the current JWT token from config.py (eyJ0eXAi... value)

2. Create `dolphin/.env` with the actual token:
   ```
   DOLPHIN_API_KEY=<extracted_token>
   DOLPHIN_API_URL=https://dolphin-anty-api.com
   ```

3. Create `dolphin/.env.example` (template for other developers):
   ```
   # Dolphin Anty API credentials
   DOLPHIN_API_KEY=your_jwt_token_here
   DOLPHIN_API_URL=https://dolphin-anty-api.com

   # Rate limiting (optional overrides)
   REDDIT_USER_AGENT=DolphinTracker/2.0
   REDDIT_MIN_DELAY=2.0
   REDDIT_MAX_DELAY=5.0
   ```

4. Rewrite `dolphin/config.py` using pydantic-settings pattern from research:
   - Use `pydantic_settings.BaseSettings` with `SettingsConfigDict`
   - Use `pydantic.SecretStr` for DOLPHIN_API_KEY (hides in logs)
   - Include Reddit rate limiting settings with defaults
   - Add validation to ensure API key is not empty
   - Export singleton `settings` instance
   - Add backward-compatible exports: `DOLPHIN_API_KEY`, `DOLPHIN_API_URL` for tracker.py

Reference the exact pattern from 01-RESEARCH.md "Complete Settings Class" example.

CRITICAL: The new config.py must export DOLPHIN_API_KEY and DOLPHIN_API_URL as module-level constants so tracker.py continues to work without modification until Plan 01-03.
  </action>
  <verify>
- `cat dolphin/.env | head -1` shows DOLPHIN_API_KEY line (exists, has value)
- `cat dolphin/.env.example | head -1` shows template line
- `grep -c "eyJ0" dolphin/config.py` returns 0 (no hardcoded JWT)
- `python -c "from dolphin.config import settings; print(settings.dolphin_api_key)"` runs without error
- `python -c "from dolphin.config import DOLPHIN_API_KEY; print('OK')"` runs without error (backward compat)
  </verify>
  <done>Credentials in .env, config.py uses pydantic-settings, no secrets in source code</done>
</task>

<task type="auto">
  <name>Task 3: Verify security and backward compatibility</name>
  <files>None (verification only)</files>
  <action>
1. Verify .env is git-ignored:
   - `git status` should NOT show .env as untracked
   - `git check-ignore dolphin/.env` should return the path

2. Verify tracker.py still works with new config:
   - `cd dolphin && python -c "from config import DOLPHIN_API_KEY, DOLPHIN_API_URL; print('Config OK')"`
   - `cd dolphin && python tracker.py --test` (should check 5 accounts successfully)

3. Verify no secrets in committed files:
   - `grep -r "eyJ0" dolphin/*.py` should return nothing
   - `grep -r "eyJ0" dolphin/*.example` should return nothing

4. Stage and commit security files:
   - Stage: .gitignore, .env.example, config.py, requirements.txt
   - Do NOT stage: .env (should be ignored)
   - Commit message: "fix(security): move credentials to .env file"
  </action>
  <verify>
- `git check-ignore dolphin/.env` returns path (ignored)
- `cd dolphin && python tracker.py --test` completes without import errors
- `git diff --cached --name-only` shows only safe files (.gitignore, .env.example, config.py, requirements.txt)
  </verify>
  <done>Security hardening complete, tracker.py works, changes committed</done>
</task>

</tasks>

<verification>
Run the following checks to verify Phase 1 Plan 01 is complete:

```bash
# 1. No secrets in source code
grep -r "eyJ0" dolphin/*.py && echo "FAIL: JWT found" || echo "PASS: No JWT in source"

# 2. .env is ignored
git check-ignore dolphin/.env && echo "PASS: .env ignored" || echo "FAIL: .env not ignored"

# 3. Settings load correctly
python -c "from dolphin.config import settings; print('API URL:', settings.dolphin_api_url)"

# 4. Backward compatibility
python -c "from dolphin.config import DOLPHIN_API_KEY, DOLPHIN_API_URL; print('Compat OK')"

# 5. Tracker runs
cd dolphin && python tracker.py --test
```
</verification>

<success_criteria>
1. DOLPHIN_API_KEY loads from .env file (not hardcoded)
2. config.py contains no JWT tokens or API keys
3. .env file is git-ignored
4. tracker.py works with `--test` flag (backward compatible)
5. Changes committed to git (excluding .env)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-01-SUMMARY.md`
</output>
