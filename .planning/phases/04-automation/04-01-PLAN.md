---
phase: 04-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/config.py
  - dolphin/tracker.py
  - dolphin/logs/.gitkeep
  - ~/Library/LaunchAgents/com.dolphin.tracker.plist
autonomous: false

must_haves:
  truths:
    - "Script runs automatically at 9 AM daily without manual intervention"
    - "All tracker output is logged to file with timestamps"
    - "Failed runs return non-zero exit code and log the error"
    - "Logs rotate daily with 30-day retention"
    - "Mac waking from sleep triggers missed job"
  artifacts:
    - path: "dolphin/config.py"
      provides: "setup_logging() function"
      contains: "TimedRotatingFileHandler"
    - path: "dolphin/tracker.py"
      provides: "main() entry point with proper exit codes"
      contains: "sys.exit"
    - path: "dolphin/logs/.gitkeep"
      provides: "Log directory (gitignored contents)"
    - path: "~/Library/LaunchAgents/com.dolphin.tracker.plist"
      provides: "launchd job definition"
      contains: "StartCalendarInterval"
  key_links:
    - from: "com.dolphin.tracker.plist"
      to: "dolphin/tracker.py"
      via: "ProgramArguments with absolute Python path"
      pattern: "python.*tracker\\.py"
    - from: "tracker.py main()"
      to: "config.py setup_logging()"
      via: "function call at entry"
      pattern: "setup_logging\\(\\)"
---

<objective>
Set up automated daily execution of the tracker script using macOS launchd.

Purpose: Enable hands-off operation where Google Sheet updates daily without human action.
Output: Working scheduled job with file-based logging and proper error handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-automation/04-RESEARCH.md
@dolphin/config.py
@dolphin/tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logging infrastructure</name>
  <files>dolphin/config.py, dolphin/logs/.gitkeep, dolphin/.gitignore</files>
  <action>
Add `setup_logging()` function to config.py that:

1. Creates `dolphin/logs/` directory if not exists
2. Configures `TimedRotatingFileHandler`:
   - File: `dolphin/logs/tracker.log`
   - Rotation: midnight daily
   - Retention: 30 days (backupCount=30)
   - Suffix format: `%Y-%m-%d`
   - Encoding: utf-8
3. Adds console handler (for launchd capture)
4. Formatter: `%(asctime)s [%(levelname)s] %(message)s` with `%Y-%m-%d %H:%M:%S`
5. Returns logger named "tracker" at INFO level
6. Includes guard against duplicate handlers (check if logger.handlers before adding)

Required imports at top of config.py:
- `import logging`
- `from logging.handlers import TimedRotatingFileHandler`

Create `dolphin/logs/.gitkeep` (empty file to track directory).

Update `dolphin/.gitignore` to add:
```
logs/*.log
logs/*.log.*
```
  </action>
  <verify>
Run: `python3 -c "from config import setup_logging; logger = setup_logging(); logger.info('Test log'); print('OK')"`
Check: `ls dolphin/logs/tracker.log` exists with test entry
  </verify>
  <done>
- setup_logging() function exists in config.py
- Calling it creates logs/tracker.log with timestamped entries
- Log files gitignored, .gitkeep tracked
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor tracker.py for scheduled execution</name>
  <files>dolphin/tracker.py</files>
  <action>
Modify tracker.py for scheduled execution:

1. Add imports at top:
   - `import logging` (if not present)
   - `from config import setup_logging`

2. Add module-level logger after imports:
   ```python
   logger = logging.getLogger("tracker")
   ```

3. Modify `run_tracker()` to:
   - Return `int` (exit code: 0=success, 1=failure)
   - Replace all `print()` calls with `logger.info()` or `logger.warning()`
   - Wrap body in try/except, log exceptions with `logger.exception()`, return 1 on error
   - Return 0 at end on success

4. Add new `main()` function:
   ```python
   def main() -> int:
       """Entry point for scheduled execution."""
       setup_logging()

       logger.info("=" * 60)
       logger.info("Starting scheduled tracker run")

       try:
           exit_code = asyncio.run(run_tracker())
           if exit_code == 0:
               logger.info("Tracker completed successfully")
           else:
               logger.error(f"Tracker completed with errors (exit code: {exit_code})")
           return exit_code
       except KeyboardInterrupt:
           logger.warning("Tracker interrupted by user")
           return 130
       except Exception as e:
           logger.exception(f"Tracker failed with unexpected error: {e}")
           return 1
   ```

5. Update `if __name__ == "__main__":` block:
   ```python
   if __name__ == "__main__":
       test_mode = "--test" in sys.argv
       if test_mode:
           # Interactive testing - setup logging but stay in foreground
           setup_logging()
           asyncio.run(run_tracker(limit=5))
       else:
           # Scheduled execution - proper entry point with exit codes
           sys.exit(main())
   ```

Key changes to print statements (examples):
- `print(f"[{datetime.now()...}] Starting tracker...")` -> `logger.info("Starting tracker...")`
- `print(f"Found {len(profiles)} profiles")` -> `logger.info(f"Found {len(profiles)} profiles")`
- `print(f"Warning: Sheets sync failed: {e}")` -> `logger.warning(f"Sheets sync failed: {e}")`
  </action>
  <verify>
Run: `cd /Users/johnasbury/Reachh/dolphin && python3 tracker.py --test`
Check:
- Output appears in terminal AND in logs/tracker.log
- Script completes without error

Run: `cd /Users/johnasbury/Reachh/dolphin && python3 tracker.py; echo "Exit code: $?"`
Check: Exit code is 0 on success
  </verify>
  <done>
- tracker.py uses logging instead of print
- main() function exists with proper error handling
- Exit code 0 on success, non-zero on failure
- --test mode still works for interactive testing
  </done>
</task>

<task type="auto">
  <name>Task 3: Create launchd plist and load job</name>
  <files>~/Library/LaunchAgents/com.dolphin.tracker.plist</files>
  <action>
Create launchd plist for daily 9 AM execution.

1. First, find the Python interpreter path. Since no venv exists, use system Python:
   - Run: `which python3` to get exact path
   - Expected: `/Library/Frameworks/Python.framework/Versions/3.13/bin/python3`

2. Create plist at `~/Library/LaunchAgents/com.dolphin.tracker.plist`:
   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
   <plist version="1.0">
   <dict>
       <key>Label</key>
       <string>com.dolphin.tracker</string>

       <key>ProgramArguments</key>
       <array>
           <string>/Library/Frameworks/Python.framework/Versions/3.13/bin/python3</string>
           <string>/Users/johnasbury/Reachh/dolphin/tracker.py</string>
       </array>

       <key>WorkingDirectory</key>
       <string>/Users/johnasbury/Reachh/dolphin</string>

       <key>StartCalendarInterval</key>
       <dict>
           <key>Hour</key>
           <integer>9</integer>
           <key>Minute</key>
           <integer>0</integer>
       </dict>

       <key>StandardOutPath</key>
       <string>/Users/johnasbury/Reachh/dolphin/logs/launchd.stdout</string>
       <key>StandardErrorPath</key>
       <string>/Users/johnasbury/Reachh/dolphin/logs/launchd.stderr</string>
   </dict>
   </plist>
   ```

3. Validate plist syntax:
   ```bash
   plutil -lint ~/Library/LaunchAgents/com.dolphin.tracker.plist
   ```

4. Load the job:
   ```bash
   launchctl load ~/Library/LaunchAgents/com.dolphin.tracker.plist
   ```

5. Verify loaded:
   ```bash
   launchctl list | grep dolphin
   ```

6. Test immediate execution:
   ```bash
   launchctl start com.dolphin.tracker
   ```

7. Check logs for successful run:
   ```bash
   tail -20 /Users/johnasbury/Reachh/dolphin/logs/tracker.log
   ```
  </action>
  <verify>
Run: `launchctl list | grep dolphin`
Check: Shows `com.dolphin.tracker` with PID or exit code

Run: `tail -5 /Users/johnasbury/Reachh/dolphin/logs/tracker.log`
Check: Shows recent "Starting scheduled tracker run" and "completed successfully"
  </verify>
  <done>
- Plist exists at ~/Library/LaunchAgents/com.dolphin.tracker.plist
- Job is loaded (shows in launchctl list)
- Manual trigger (launchctl start) completes successfully
- Logs show successful execution
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Automated daily tracker execution via macOS launchd:
- Logging infrastructure with daily rotation (30-day retention)
- tracker.py refactored for scheduled execution with proper exit codes
- launchd job configured for 9 AM daily runs
  </what-built>
  <how-to-verify>
1. Check logs exist:
   ```bash
   ls -la ~/Reachh/dolphin/logs/
   ```
   Expected: tracker.log, launchd.stdout, launchd.stderr

2. Check job is scheduled:
   ```bash
   launchctl list | grep dolphin
   ```
   Expected: Shows com.dolphin.tracker

3. Trigger manual run and verify:
   ```bash
   launchctl start com.dolphin.tracker
   sleep 60  # Wait for tracker to complete
   tail -30 ~/Reachh/dolphin/logs/tracker.log
   ```
   Expected: Shows "Starting scheduled tracker run" and "completed successfully"

4. Check Google Sheet updated (visit sheet URL)

5. (Optional) To test wake behavior: sleep Mac, wake it after 9 AM, check if job ran
  </how-to-verify>
  <resume-signal>Type "approved" if automation works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Logging works:**
   - `dolphin/logs/tracker.log` exists with timestamped entries
   - Old logs rotate with date suffix (tracker.log.YYYY-MM-DD)

2. **Scheduled execution works:**
   - `launchctl list | grep dolphin` shows job
   - `launchctl start com.dolphin.tracker` runs successfully
   - Exit code 0 on success, 1 on failure

3. **Error handling works:**
   - Intentional error (e.g., bad API key) logs exception and returns exit 1
   - Keyboard interrupt returns exit 130
</verification>

<success_criteria>
- Script runs automatically at 9 AM daily (StartCalendarInterval)
- Google Sheet updates without human action
- All output logged to dolphin/logs/tracker.log with timestamps
- Failures produce non-zero exit code and logged exception
- Job survives Mac sleep/wake (runs on wake if missed)
</success_criteria>

<output>
After completion, create `.planning/phases/04-automation/04-01-SUMMARY.md`
</output>
