---
phase: 02-warmup-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - dolphin/sheets_sync.py
  - dolphin/alerts.py
  - dolphin/tracker.py
  - dolphin/models.py
autonomous: true

must_haves:
  truths:
    - "Google Sheet shows activity counts and warmup status for each account"
    - "Alerts fire when accounts approach or exceed daily limits"
    - "Tracker fetches activity counts for active accounts on each run"
  artifacts:
    - path: "dolphin/sheets_sync.py"
      provides: "Extended HEADERS with warmup columns"
      contains: "comments_today"
    - path: "dolphin/alerts.py"
      provides: "notify_warmup_warnings() function"
      contains: "def notify_warmup_warnings"
    - path: "dolphin/tracker.py"
      provides: "Activity fetching and threshold checking in run_tracker()"
      contains: "get_activity_counts"
    - path: "dolphin/models.py"
      provides: "Extended AccountResult with activity field"
      contains: "activity: ActivityCounts"
  key_links:
    - from: "dolphin/tracker.py"
      to: "dolphin/warmup.py"
      via: "imports check_warmup_thresholds"
      pattern: "from warmup import"
    - from: "dolphin/tracker.py"
      to: "dolphin/sources/reddit.py"
      via: "calls get_activity_counts()"
      pattern: "get_activity_counts"
    - from: "dolphin/alerts.py"
      to: "Slack webhook"
      via: "send_alert()"
      pattern: "notify_warmup_warnings"
---

<objective>
Integrate warmup tracking into the tracker, sheets, and alerts.

Purpose: Make warmup activity visible in Google Sheets and trigger alerts when accounts exceed safe thresholds. This completes the enforcement loop.

Output: Extended tracker that fetches activity counts, extended sheets with warmup columns, warmup alerts for threshold violations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-warmup-management/02-RESEARCH.md
@.planning/phases/02-warmup-management/02-01-SUMMARY.md

# Files to extend
@dolphin/sheets_sync.py
@dolphin/alerts.py
@dolphin/tracker.py
@dolphin/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend sheets and alerts for warmup</name>
  <files>dolphin/sheets_sync.py, dolphin/alerts.py, dolphin/models.py</files>
  <action>
**1. Extend `dolphin/models.py` AccountResult:**

Add activity field to AccountResult dataclass:
```python
activity: ActivityCounts | None = None
```

Import ActivityCounts at top if not already imported.

**2. Extend `dolphin/sheets_sync.py`:**

Update HEADERS to add 4 new columns after "karma_delta" (column L):
```python
HEADERS = [
    # ... existing A-L columns ...
    "comments_today",   # M: Daily comment count
    "posts_today",      # N: Daily post count
    "warmup_tier",      # O: new/warming/ready/established
    "limit_status",     # P: OK/WARNING/EXCEEDED
    "checked_at",       # Q: (moved from M)
]
```

Update `_to_row()` function to include new columns:
- Get activity counts from result.activity (default to 0 if None)
- Calculate warmup tier using get_warmup_limits(result.reddit.created_utc)
- Determine limit_status:
  - Import check_warmup_thresholds from warmup
  - If no activity data: "N/A"
  - If any warning contains "EXCEEDED": "EXCEEDED"
  - If any warning contains "WARNING": "WARNING"
  - Otherwise: "OK"

Update `_ensure_headers()` range from "A1:M1" to "A1:Q1".

Update all batch update ranges from "A{row}:M{row}" to "A{row}:Q{row}".

Update summary row function to include warmup stats:
- Count accounts by limit_status (OK/WARNING/EXCEEDED)
- Add warmup summary to the appropriate column

**3. Extend `dolphin/alerts.py`:**

Add new function:
```python
def notify_warmup_warnings(warnings: list[dict]) -> None:
    """
    Notify about accounts approaching/exceeding warmup limits.

    Args:
        warnings: List of dicts with 'username' and 'message' keys
    """
    if not warnings:
        return

    exceeded = [w for w in warnings if "EXCEEDED" in w["message"]]
    approaching = [w for w in warnings if "WARNING" in w["message"]]

    if exceeded:
        user_list = ", ".join(w["username"] for w in exceeded[:5])
        if len(exceeded) > 5:
            user_list += f" (+{len(exceeded) - 5} more)"
        send_alert(
            title="Warmup Limit EXCEEDED",
            message=f"{len(exceeded)} account(s) over limit: {user_list}",
        )

    if approaching:
        user_list = ", ".join(w["username"] for w in approaching[:5])
        if len(approaching) > 5:
            user_list += f" (+{len(approaching) - 5} more)"
        send_alert(
            title="Warmup Warning",
            message=f"{len(approaching)} account(s) near limit: {user_list}",
        )
```
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python -c "
from sheets_sync import HEADERS, _to_row
from alerts import notify_warmup_warnings
from models import AccountResult, DolphinProfile, RedditStatus, ActivityCounts, ProxyHealth

# Test headers extended
assert 'comments_today' in HEADERS
assert 'posts_today' in HEADERS
assert 'warmup_tier' in HEADERS
assert 'limit_status' in HEADERS
assert len(HEADERS) == 17  # A-Q = 17 columns

# Test _to_row with activity
profile = DolphinProfile(id='123', name='testuser', owner='owner', notes='', created_at='', updated_at='')
reddit = RedditStatus(username='testuser', status='active', total_karma=100, created_utc=1704067200)  # Jan 2024
activity = ActivityCounts(username='testuser', comments_today=2, posts_today=0)
result = AccountResult(profile=profile, reddit=reddit, category='active', activity=activity)
row = _to_row(result)
assert len(row) == 17
print(f'Row columns: {len(row)}')
print(f'Warmup tier in row: {row[14]}')  # Index 14 = warmup_tier

# Test alert function exists
print('notify_warmup_warnings function exists')
print('All sheets/alerts tests passed')
"
```
  </verify>
  <done>
- HEADERS has 17 columns (A-Q) including warmup columns
- _to_row() returns 17-column row with activity data
- notify_warmup_warnings() function exists and sends alerts
- AccountResult has activity field
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate warmup tracking into tracker</name>
  <files>dolphin/tracker.py</files>
  <action>
Extend `run_tracker()` in `dolphin/tracker.py` to fetch activity counts and check thresholds:

**1. Add imports at top:**
```python
from warmup import get_warmup_limits, check_warmup_thresholds
from alerts import notify_bans, notify_proxy_failures, notify_warmup_warnings
```

**2. Inside the profile loop, after checking Reddit status:**

After `status = await reddit.check_account(profile.name)` and the karma logging, add:

```python
# Fetch activity counts for active accounts
activity = None
if status.status == "active":
    activity = await reddit.get_activity_counts(profile.name)
    logger.debug(f"  Activity: {activity.comments_today} comments, {activity.posts_today} posts today")
```

**3. Pass activity to AccountResult:**

Update the AccountResult creation to include activity:
```python
result = AccountResult(
    profile=profile,
    reddit=status,
    category=category,
    karma_change=karma_change,
    checked_at=datetime.now().isoformat(),
    proxy_health=proxy_health,
    activity=activity,  # Add this line
)
```

**4. After the profile loop, check warmup thresholds:**

After `results.append(result)` loop completes but before state tracking, add:

```python
# Check warmup thresholds and collect warnings
warmup_warnings = []
for result in results:
    if result.activity and result.reddit.status == "active":
        limits_info = get_warmup_limits(result.reddit.created_utc)
        if limits_info["limits"]:
            warnings = check_warmup_thresholds(
                result.activity,
                limits_info["limits"],
            )
            for warning in warnings:
                warmup_warnings.append({
                    "username": result.profile.name,
                    "message": warning,
                })

# Send warmup alerts
if warmup_warnings:
    logger.warning(f"Warmup warnings: {len(warmup_warnings)} account(s)")
    notify_warmup_warnings(warmup_warnings)
```

**5. Update summary logging to include warmup stats:**

After the existing category summary, add:
```python
# Log warmup status breakdown
warmup_tiers = Counter()
limit_statuses = Counter()
for r in results:
    if r.activity and r.reddit.status == "active":
        limits_info = get_warmup_limits(r.reddit.created_utc)
        warmup_tiers[limits_info["tier"]] += 1
        warnings = check_warmup_thresholds(r.activity, limits_info.get("limits", {}))
        if any("EXCEEDED" in w for w in warnings):
            limit_statuses["EXCEEDED"] += 1
        elif any("WARNING" in w for w in warnings):
            limit_statuses["WARNING"] += 1
        else:
            limit_statuses["OK"] += 1

if warmup_tiers:
    logger.info("=== WARMUP STATUS ===")
    for tier, count in warmup_tiers.most_common():
        logger.info(f"  {tier}: {count}")
    for status, count in limit_statuses.most_common():
        logger.info(f"  {status}: {count}")
```
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python -c "
# Verify tracker imports work
from tracker import run_tracker, categorize_account
from warmup import get_warmup_limits, check_warmup_thresholds
from alerts import notify_warmup_warnings
print('All tracker imports successful')

# Verify the imports are in tracker.py
import inspect
import tracker
source = inspect.getsource(tracker)
assert 'get_warmup_limits' in source or 'from warmup import' in source
assert 'notify_warmup_warnings' in source or 'from alerts import.*notify_warmup_warnings' in source
print('Warmup integration present in tracker')
"
```

Run a quick test with --test flag (checks 5 profiles):
```bash
cd /Users/johnasbury/Reachh/dolphin && python tracker.py --test 2>&1 | head -50
```
  </verify>
  <done>
- Tracker imports warmup and alert functions
- Activity counts fetched for active accounts
- AccountResult includes activity data
- Warmup thresholds checked after fetching
- Warmup warnings sent via alerts
- Summary includes warmup tier breakdown
  </done>
</task>

</tasks>

<verification>
Full integration test (run tracker in test mode):
```bash
cd /Users/johnasbury/Reachh/dolphin && python tracker.py --test 2>&1 | grep -E "(Activity|WARMUP|comments|posts)"
```

Verify sheets would receive correct columns:
```bash
cd /Users/johnasbury/Reachh/dolphin && python -c "
from sheets_sync import HEADERS
print('Sheet columns:', HEADERS)
print('Total columns:', len(HEADERS))
"
```
</verification>

<success_criteria>
- [ ] Tracker fetches activity counts for active accounts
- [ ] AccountResult includes activity field
- [ ] Sheets HEADERS has 17 columns including warmup data
- [ ] notify_warmup_warnings() sends alerts for threshold violations
- [ ] Tracker summary includes warmup tier breakdown
- [ ] Test mode run completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-warmup-management/02-02-SUMMARY.md`
</output>
