---
phase: 02-warmup-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dolphin/warmup.py
  - dolphin/sources/reddit.py
  - dolphin/models.py
autonomous: true

must_haves:
  truths:
    - "Warmup limits are defined for 4 tiers (new, warming, ready, established)"
    - "Activity counts can be fetched from Reddit API for any username"
    - "Account age determines which tier's limits apply"
  artifacts:
    - path: "dolphin/warmup.py"
      provides: "WARMUP_TIERS config, get_warmup_limits(), check_warmup_thresholds()"
      min_lines: 60
    - path: "dolphin/sources/reddit.py"
      provides: "get_activity_counts() method on RedditChecker"
      contains: "get_activity_counts"
    - path: "dolphin/models.py"
      provides: "ActivityCounts dataclass"
      contains: "class ActivityCounts"
  key_links:
    - from: "dolphin/warmup.py"
      to: "dolphin/models.py"
      via: "imports ActivityCounts"
      pattern: "from models import.*ActivityCounts"
---

<objective>
Create the warmup limits system and activity counting infrastructure.

Purpose: Define safe activity thresholds by account age and enable fetching daily activity counts from Reddit API. This is the foundation for warmup enforcement.

Output: New warmup.py module with tier definitions and threshold checking, extended reddit.py with activity counting method, new ActivityCounts dataclass.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-warmup-management/02-RESEARCH.md

# Existing files to extend
@dolphin/models.py
@dolphin/sources/reddit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create warmup limits module</name>
  <files>dolphin/warmup.py, dolphin/models.py</files>
  <action>
Create `dolphin/warmup.py` with:

1. WARMUP_TIERS dict defining 4 tiers (from research):
   - "new" (days 1-7): max_comments=3, max_posts=0, max_votes=10, target_karma=15
   - "warming" (days 8-14): max_comments=5, max_posts=1, max_votes=20, target_karma=100
   - "ready" (days 15-30): max_comments=8, max_posts=2, max_votes=30, target_karma=250
   - "established" (days 30+): max_comments=15, max_posts=3, max_votes=50, target_karma=500

2. `get_warmup_limits(created_utc: float) -> dict`:
   - Calculate account age in days from created_utc timestamp
   - Return dict with `tier` name and `limits` from WARMUP_TIERS
   - Handle invalid timestamps (return tier="unknown", limits=None)

3. `check_warmup_thresholds(activity: ActivityCounts, limits: dict, alert_threshold: float = 0.8) -> list[str]`:
   - Compare activity.comments_today against limits["max_comments"]
   - Compare activity.posts_today against limits["max_posts"]
   - Return list of warning strings:
     - "EXCEEDED: {username} has {N} comments (limit: {M})" if at/over 100%
     - "WARNING: {username} at {N}% of comment limit" if at/over 80%
   - Same pattern for posts
   - Skip check if limit is 0 (e.g., no posts allowed for new tier)

Add to `dolphin/models.py`:

4. `ActivityCounts` dataclass:
   - username: str
   - comments_today: int = 0
   - posts_today: int = 0
   - fetched_at: str = "" (ISO timestamp)

Note: Votes cannot be tracked via API (private data) - only comments and posts.
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python -c "
from warmup import WARMUP_TIERS, get_warmup_limits, check_warmup_thresholds
from models import ActivityCounts
import time

# Test tiers defined
assert len(WARMUP_TIERS) == 4
assert 'new' in WARMUP_TIERS
assert WARMUP_TIERS['new']['max_comments'] == 3

# Test get_warmup_limits
now = time.time()
new_account = now - (3 * 86400)  # 3 days old
result = get_warmup_limits(new_account)
assert result['tier'] == 'new'

old_account = now - (60 * 86400)  # 60 days old
result = get_warmup_limits(old_account)
assert result['tier'] == 'established'

# Test threshold checking
activity = ActivityCounts(username='test', comments_today=3, posts_today=0)
limits = WARMUP_TIERS['new']
warnings = check_warmup_thresholds(activity, limits)
assert any('EXCEEDED' in w or 'WARNING' in w for w in warnings)

print('All warmup module tests passed')
"
```
  </verify>
  <done>
- WARMUP_TIERS dict exists with 4 tiers
- get_warmup_limits() returns correct tier based on account age
- check_warmup_thresholds() returns warnings at 80% and 100% thresholds
- ActivityCounts dataclass exists in models.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Add activity counting to RedditChecker</name>
  <files>dolphin/sources/reddit.py</files>
  <action>
Extend `RedditChecker` class in `dolphin/sources/reddit.py` with:

1. `async def get_activity_counts(self, username: str) -> ActivityCounts`:
   - Import ActivityCounts from models at top of file
   - Get today's date in UTC: `today = datetime.now(tz=timezone.utc).date()`

   - Fetch recent comments:
     ```
     comments_url = f"https://www.reddit.com/user/{username}/comments.json?limit=25"
     ```
   - Use existing `self._random_delay()` before request
   - Parse response, count comments where `created_utc` date == today

   - Fetch recent submissions:
     ```
     posts_url = f"https://www.reddit.com/user/{username}/submitted.json?limit=10"
     ```
   - Use `self._random_delay()` before request
   - Count posts where `created_utc` date == today

   - Return ActivityCounts with username, counts, and fetched_at timestamp

   - Handle errors gracefully:
     - On 404/403: Return ActivityCounts with 0 counts (account may be suspended)
     - On 429: Return ActivityCounts with 0 counts (don't block on rate limit)
     - On network error: Return ActivityCounts with 0 counts

2. Add required imports at top:
   ```python
   from datetime import datetime, timezone
   from models import RedditStatus, ActivityCounts
   ```

Note: This method is designed to be called AFTER check_account() confirms the account is active. Only active accounts need activity tracking.
  </action>
  <verify>
```bash
cd /Users/johnasbury/Reachh/dolphin && python -c "
import asyncio
from sources.reddit import RedditChecker
from models import ActivityCounts

async def test():
    async with RedditChecker() as checker:
        # Test with a known active account (spez is Reddit CEO, always active)
        activity = await checker.get_activity_counts('spez')
        assert isinstance(activity, ActivityCounts)
        assert activity.username == 'spez'
        assert isinstance(activity.comments_today, int)
        assert isinstance(activity.posts_today, int)
        assert activity.fetched_at != ''
        print(f'Activity for spez: {activity.comments_today} comments, {activity.posts_today} posts')
        print('Activity counting test passed')

asyncio.run(test())
"
```
  </verify>
  <done>
- get_activity_counts() method exists on RedditChecker
- Returns ActivityCounts dataclass
- Fetches comments and posts from Reddit API
- Counts only today's activity
- Handles errors gracefully without crashing
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/johnasbury/Reachh/dolphin && python -c "
from warmup import WARMUP_TIERS, get_warmup_limits, check_warmup_thresholds
from models import ActivityCounts
from sources.reddit import RedditChecker
print('All imports successful')
print(f'Tiers: {list(WARMUP_TIERS.keys())}')
print('Phase 02-01 verification complete')
"
```
</verification>

<success_criteria>
- [ ] dolphin/warmup.py exists with WARMUP_TIERS, get_warmup_limits(), check_warmup_thresholds()
- [ ] dolphin/models.py has ActivityCounts dataclass
- [ ] dolphin/sources/reddit.py has get_activity_counts() method
- [ ] All verification commands pass
- [ ] No import errors when loading modules
</success_criteria>

<output>
After completion, create `.planning/phases/02-warmup-management/02-01-SUMMARY.md`
</output>
